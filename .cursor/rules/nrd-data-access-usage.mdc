---
alwaysApply: true
---
# NRD Data Access Library - Guía de Uso para Microfrontends

Esta guía documenta cómo los microfrontends deben usar la librería NRD Data Access para interactuar con Firebase Realtime Database.

## Instalación e Inicialización

### Incluir la Librería en HTML

```html
<!-- Opción 1: jsDelivr CDN (Recomendado) -->
<script src="https://cdn.jsdelivr.net/gh/yosbany/nrd-data-access@main/dist/nrd-data-access.js"></script>

<!-- Opción 2: GitHub Pages -->
<script src="https://yosbany.github.io/nrd-data-access/dist/nrd-data-access.js"></script>
```

### Inicializar en JavaScript

```javascript
// Crear instancia global (típicamente en index.html o app.js)
const nrd = new NRDDataAccess();
```

## Servicios Disponibles

La librería expone los siguientes servicios a través de la instancia `nrd`:

- `nrd.auth` - Autenticación
- `nrd.accounts` - Cuentas
- `nrd.areas` - Áreas
- `nrd.categories` - Categorías
- `nrd.clients` - Clientes
- `nrd.companyInfo` - Información de la empresa (objeto único)
- `nrd.contracts` - Contratos
- `nrd.employees` - Empleados
- `nrd.orders` - Pedidos
- `nrd.processes` - Procesos
- `nrd.products` - Productos
- `nrd.roles` - Roles
- `nrd.tasks` - Tareas
- `nrd.transactions` - Transacciones

## Modelos de Datos

### Account (Cuenta)
```typescript
interface Account {
  id?: string;
  name: string;
  active?: boolean;
  initialBalance?: number;
}
```

### Area (Área)
```typescript
interface Area {
  id?: string;
  name: string;
  description?: string;
  managerEmployeeId?: string;
}
```

### Category (Categoría)
```typescript
interface Category {
  id?: string;
  name: string;
  type: 'income' | 'expense';
  active?: boolean;
}
```

### Client (Cliente)
```typescript
interface Client {
  id?: string;
  name: string;
  address?: string;
  phone?: string;
  description?: string;
  preferredPrices?: PreferredPrice[];
}

interface PreferredPrice {
  productId: string;
  type: 'fijo' | 'porcentual';
  price?: number; // Precio fijo o precio calculado (si es porcentual)
  percentage?: number; // Porcentaje de descuento (solo si type es 'porcentual')
}
```

### CompanyInfo (Información de la Empresa)
```typescript
interface CompanyInfo {
  address?: string;
  email?: string;
  legalName?: string;
  mission?: string;
  mobile?: string;
  phone?: string;
  rut?: string;
  tradeName?: string;
  vision?: string;
}
```
**Nota**: `CompanyInfo` es un objeto único (no una colección), por lo que usa métodos diferentes.

### Contract (Contrato)
```typescript
interface Contract {
  id?: string;
  name: string;
  description?: string;
  importantData?: {
    [key: string]: string;
  };
  documents?: ContractDocument[];
}

interface ContractDocument {
  name: string;
  data: string; // Data URL (base64)
}
```

### Employee (Empleado)
```typescript
interface Employee {
  id?: string;
  name: string;
  roleIds?: string[];
}
```

### Order (Pedido)
```typescript
interface Order {
  id?: string;
  clientId: string;
  clientName?: string;
  status: string;
  total: number;
  createdAt?: number;
  deliveryDate?: number;
  items?: OrderItem[];
}

interface OrderItem {
  productId: string;
  productName?: string;
  quantity: number;
  price: number;
}
```

### Process (Proceso)
```typescript
interface Process {
  id?: string;
  name: string;
  areaId?: string;
  objective?: string;
  taskIds?: string[];
  activities?: ProcessActivity[];
}

interface ProcessActivity {
  name: string;
  taskId: string;
  roleId?: string;
}
```

### Product (Producto)
```typescript
interface Product {
  id?: string;
  name: string;
  sku?: string; // Código SKU para referencias internas
  price: number;
  cost?: number; // Costo del producto
  active?: boolean;
}
```

### Role (Rol)
```typescript
interface Role {
  id?: string;
  name: string;
}
```

### Task (Tarea)
```typescript
interface Task {
  id?: string;
  name: string;
  description?: string;
  processId?: string;
  order?: number;
  assignedEmployeeId?: string;
  estimatedTime?: number;
  executionSteps?: string[];
  successCriteria?: string[];
  commonErrors?: string[];
}
```

### Transaction (Transacción)
```typescript
interface Transaction {
  id?: string;
  type: 'income' | 'expense';
  accountId: string;
  accountName?: string;
  amount: number;
  categoryId?: string;
  categoryName?: string;
  description?: string;
  date: number;
  createdAt?: number;
}
```

## Métodos de Servicio (BaseService)

Todos los servicios que extienden `BaseService` (todos excepto `auth` y `companyInfo`) tienen los siguientes métodos:

### getAll()
Obtiene todos los registros de la entidad.

```javascript
const accounts = await nrd.accounts.getAll();
// Retorna: Account[]
```

### getById(id)
Obtiene un registro específico por ID.

```javascript
const account = await nrd.accounts.getById('account-id');
// Retorna: Account | null
```

### create(data)
Crea un nuevo registro. Retorna el ID generado.

```javascript
const newAccount = {
  name: 'Cuenta Principal',
  active: true,
  initialBalance: 1000
};
const accountId = await nrd.accounts.create(newAccount);
// Retorna: string (ID del nuevo registro)
```

### update(id, updates)
Actualiza un registro existente (actualización parcial).

```javascript
await nrd.accounts.update('account-id', {
  name: 'Nuevo Nombre',
  active: false
});
```

### delete(id)
Elimina un registro.

```javascript
await nrd.accounts.delete('account-id');
```

### queryByChild(childPath, value)
Consulta registros por el valor de un campo hijo.

```javascript
// Obtener todas las transacciones de una cuenta específica
const transactions = await nrd.transactions.queryByChild('accountId', 'account-id');
// Retorna: Transaction[]
```

### onValue(callback)
Escucha cambios en tiempo real de toda la colección. Retorna una función para desuscribirse.

```javascript
const unsubscribe = nrd.accounts.onValue((accounts) => {
  // accounts es un array de Account
  console.log('Cuentas actualizadas:', accounts);
  // Actualizar UI aquí
});

// Para desuscribirse:
unsubscribe();
```

### onValueById(id, callback)
Escucha cambios en tiempo real de un registro específico. Retorna una función para desuscribirse.

```javascript
const unsubscribe = nrd.accounts.onValueById('account-id', (account) => {
  // account es Account | null
  if (account) {
    console.log('Cuenta actualizada:', account);
  }
});

// Para desuscribirse:
unsubscribe();
```

### getRef()
Obtiene la referencia de Firebase a la colección (para operaciones avanzadas).

```javascript
const ref = nrd.accounts.getRef();
```

### getRefById(id)
Obtiene la referencia de Firebase a un registro específico (para operaciones avanzadas).

```javascript
const ref = nrd.accounts.getRefById('account-id');
```

## Servicio de Autenticación (AuthService)

### signIn(email, password)
Inicia sesión con email y contraseña.

```javascript
try {
  const userCredential = await nrd.auth.signIn('user@example.com', 'password');
  const user = userCredential.user;
  console.log('Usuario autenticado:', user);
} catch (error) {
  console.error('Error de autenticación:', error);
}
```

### signUp(email, password)
Crea una nueva cuenta de usuario.

```javascript
try {
  const userCredential = await nrd.auth.signUp('user@example.com', 'password');
  const user = userCredential.user;
  console.log('Usuario creado:', user);
} catch (error) {
  console.error('Error al crear usuario:', error);
}
```

### signOut()
Cierra la sesión del usuario actual.

```javascript
await nrd.auth.signOut();
```

### getCurrentUser()
Obtiene el usuario actualmente autenticado.

```javascript
const user = nrd.auth.getCurrentUser();
if (user) {
  console.log('Usuario actual:', user.email);
} else {
  console.log('No hay usuario autenticado');
}
```

### onAuthStateChanged(callback)
Escucha cambios en el estado de autenticación. Retorna una función para desuscribirse.

```javascript
const unsubscribe = nrd.auth.onAuthStateChanged((user) => {
  if (user) {
    console.log('Usuario autenticado:', user.email);
    // Mostrar contenido autenticado
  } else {
    console.log('Usuario no autenticado');
    // Redirigir a login
  }
});

// Para desuscribirse:
unsubscribe();
```

## Servicio de Información de Empresa (CompanyInfoService)

Este servicio maneja un objeto único, no una colección, por lo que tiene métodos diferentes:

### get()
Obtiene la información de la empresa.

```javascript
const companyInfo = await nrd.companyInfo.get();
// Retorna: CompanyInfo | null
```

### set(companyInfo)
Establece o reemplaza completamente la información de la empresa.

```javascript
const info = {
  tradeName: 'Mi Empresa',
  legalName: 'Mi Empresa S.A.',
  rut: '12345678-9',
  address: 'Calle Principal 123',
  phone: '+56 9 1234 5678',
  email: 'contacto@miempresa.com'
};
await nrd.companyInfo.set(info);
```

### update(updates)
Actualiza parcialmente la información de la empresa.

```javascript
await nrd.companyInfo.update({
  phone: '+56 9 9876 5432',
  email: 'nuevo@miempresa.com'
});
```

## Patrones de Uso Comunes

### Cargar y Escuchar Cambios en Tiempo Real

```javascript
let accountsListener = null;

function loadAccounts() {
  const listElement = document.getElementById('accounts-list');
  if (!listElement) return;
  
  // Remover listener anterior si existe
  if (accountsListener) {
    accountsListener();
    accountsListener = null;
  }
  
  // Crear nuevo listener
  accountsListener = nrd.accounts.onValue((accounts) => {
    listElement.innerHTML = '';
    
    if (accounts.length === 0) {
      listElement.innerHTML = '<p class="text-center text-gray-600 py-6">No hay cuentas</p>';
      return;
    }
    
    accounts.forEach((account) => {
      const item = createAccountCard(account);
      listElement.appendChild(item);
    });
  });
}

// Limpiar al cambiar de vista
function cleanup() {
  if (accountsListener) {
    accountsListener();
    accountsListener = null;
  }
}
```

### Crear con Validación

```javascript
async function createAccount() {
  try {
    showSpinner('Creando cuenta...');
    
    const accountData = {
      name: document.getElementById('account-name').value.trim(),
      active: true,
      initialBalance: parseFloat(document.getElementById('initial-balance').value) || 0
    };
    
    // Validar
    if (!accountData.name) {
      throw new Error('El nombre es requerido');
    }
    
    const accountId = await nrd.accounts.create(accountData);
    await showSuccess('Cuenta creada exitosamente');
    
    // Limpiar formulario
    document.getElementById('account-form').reset();
    
  } catch (error) {
    console.error('Error:', error);
    await showError(error.message || 'Error al crear cuenta');
  } finally {
    hideSpinner();
  }
}
```

### Actualizar con Manejo de Errores

```javascript
async function updateAccount(accountId) {
  try {
    showSpinner('Actualizando cuenta...');
    
    const updates = {
      name: document.getElementById('account-name').value.trim(),
      active: document.getElementById('account-active').checked
    };
    
    await nrd.accounts.update(accountId, updates);
    await showSuccess('Cuenta actualizada exitosamente');
    
  } catch (error) {
    console.error('Error:', error);
    await showError(error.message || 'Error al actualizar cuenta');
  } finally {
    hideSpinner();
  }
}
```

### Consultar por Campo Específico

```javascript
async function getTransactionsByAccount(accountId) {
  try {
    const transactions = await nrd.transactions.queryByChild('accountId', accountId);
    return transactions;
  } catch (error) {
    console.error('Error:', error);
    throw error;
  }
}
```

### Verificar Autenticación Antes de Operaciones

```javascript
async function performSecureOperation() {
  const user = nrd.auth.getCurrentUser();
  
  if (!user) {
    await showError('Debes iniciar sesión para realizar esta acción');
    // Redirigir a login
    return;
  }
  
  // Continuar con la operación
  try {
    await nrd.accounts.create({ name: 'Nueva Cuenta' });
  } catch (error) {
    console.error('Error:', error);
  }
}
```

### Escuchar Cambios de Autenticación

```javascript
// En app.js o index.html
let authUnsubscribe = null;

function initAuth() {
  authUnsubscribe = nrd.auth.onAuthStateChanged((user) => {
    if (user) {
      // Usuario autenticado
      showAuthenticatedUI();
      loadUserData();
    } else {
      // Usuario no autenticado
      showLoginUI();
      cleanup();
    }
  });
}

function cleanup() {
  // Limpiar listeners de datos
  if (accountsListener) {
    accountsListener();
    accountsListener = null;
  }
  // ... otros listeners
}
```

## Notas Importantes

1. **IDs**: Los IDs se generan automáticamente por Firebase cuando usas `create()`. No incluyas el campo `id` al crear.

2. **Actualizaciones Parciales**: `update()` solo actualiza los campos que proporcionas. No es necesario enviar el objeto completo.

3. **Listeners**: Siempre limpia los listeners cuando cambies de vista o destruyas componentes para evitar memory leaks.

4. **Manejo de Errores**: Siempre envuelve las operaciones async en try/catch.

5. **Conversión de Datos**: Firebase puede retornar datos como objetos o arrays. Usa la función `convertToObject()` del arquetipo si necesitas normalizar.

6. **CompanyInfo**: Es un objeto único, no una colección. Usa `get()`, `set()` y `update()` en lugar de métodos de colección.

7. **Timestamps**: Usa `Date.now()` o `new Date().getTime()` para campos de fecha (retorna número en milisegundos).

8. **Validación**: Valida los datos antes de enviarlos a Firebase para evitar errores en tiempo de ejecución.
