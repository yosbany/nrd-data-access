<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#dc2626">
    <title>NRD Data Access Admin</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Force cache reload with version parameter in URL -->
    <script>
      (function() {
        // Get current version from stylesheet link (this is the source of truth)
        const stylesheet = document.querySelector('link[href*="styles.css"]');
        const versionMatch = stylesheet ? stylesheet.href.match(/[?&]v=(\d+)/) : null;
        
        // Only proceed if we have a version in the stylesheet
        if (!versionMatch) {
          return; // No version in stylesheet, skip cache busting
        }
        
        const currentVersion = versionMatch[1];
        
        // Get version from URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlVersion = urlParams.get('v');
        
        // If URL version doesn't match current version, reload with new version
        // But only if URL version exists (to avoid infinite loops)
        if (urlVersion && urlVersion !== currentVersion) {
          // Clear service worker cache if available
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for(let registration of registrations) {
                registration.unregister();
              }
            });
          }
          
          // Clear all caches
          if ('caches' in window) {
            caches.keys().then(function(names) {
              for (let name of names) {
                caches.delete(name);
        }
            });
          }
          
          // Reload with new version
          const url = new URL(window.location.href);
          url.searchParams.set('v', currentVersion);
          window.location.replace(url.toString());
        } else if (!urlVersion && currentVersion) {
          // If no version in URL but we have one in stylesheet, add it (first load)
          const url = new URL(window.location.href);
          url.searchParams.set('v', currentVersion);
          window.history.replaceState({}, '', url.toString());
        }
      })();
    </script>
    
    <script src="https://cdn.jsdelivr.net/gh/yosbany/nrd-data-access@main/dist/nrd-data-access.js"></script>
    <script src="auth.js"></script>
    <script src="tabs/inicio.js"></script>
    <script src="tabs/fcm-tokens.js"></script>
    <script src="app.js"></script>
    
    <!-- PWA Install -->
    <script>
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('install-btn');
        if (installBtn) installBtn.classList.remove('hidden');
      });
      
      window.addEventListener('appinstalled', () => {
        const installBtn = document.getElementById('install-btn');
        if (installBtn) installBtn.classList.add('hidden');
        deferredPrompt = null;
      });
      
      document.addEventListener('DOMContentLoaded', () => {
        const installBtn = document.getElementById('install-btn');
        if (installBtn) {
          installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) {
              alert('Para instalar esta app:\n\nChrome/Edge: Menú → Instalar aplicación\nSafari: Compartir → Añadir a pantalla de inicio\nFirefox: Menú → Instalar');
              return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              installBtn.classList.add('hidden');
        }
            deferredPrompt = null;
          });
        }
      });
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased">
    <!-- Vista de Login -->
    <div id="login-container" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full bg-white border border-gray-200 rounded-lg p-4 sm:p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-xl sm:text-2xl font-light tracking-tight text-gray-800 mb-2">NRD Data Access Admin</h1>
                <p class="text-sm sm:text-base text-gray-600">Administración de datos</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block mb-1.5 sm:mb-2 text-xs uppercase tracking-wider text-gray-600">
                        Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        autocomplete="email"
                        required
                        class="w-full px-0 py-2 border-0 border-b border-gray-300 focus:outline-none focus:border-red-600 bg-transparent text-sm sm:text-base"
                        placeholder="usuario@email.com"
                    >
                </div>
                
                <div>
                    <label for="password" class="block mb-1.5 sm:mb-2 text-xs uppercase tracking-wider text-gray-600">
                        Contraseña
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        autocomplete="current-password"
                        required
                        class="w-full px-0 py-2 border-0 border-b border-gray-300 focus:outline-none focus:border-red-600 bg-transparent text-sm sm:text-base"
                        placeholder="••••••••"
                    >
                </div>
                
                <div id="error-message" class="hidden text-red-600 text-sm sm:text-base text-center"></div>
                
                <button 
                    type="submit"
                    class="w-full px-4 sm:px-6 py-2 bg-red-600 text-white border border-red-600 hover:bg-red-700 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light"
                >
                        Iniciar Sesión
                    </button>
            </form>
        </div>
    </div>

    <!-- Vista Principal -->
    <div id="app-container" class="hidden min-h-screen">
            <!-- Header -->
        <header class="bg-red-600 border-b border-red-700 px-3 sm:px-4 py-2.5 sm:py-3 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-2 sm:gap-3">
                <img src="icon-192.png" alt="NRD Data Access Admin" class="w-8 h-8 sm:w-10 sm:h-10 rounded">
                <h1 class="text-lg sm:text-xl font-light tracking-tight text-white">NRD Data Access Admin</h1>
            </div>
            <div class="flex gap-2 items-center">
                <button 
                    id="install-btn"
                    class="px-3 sm:px-4 py-1.5 sm:py-2 border border-white/30 hover:border-white text-white hover:bg-white/10 transition-colors uppercase tracking-wider text-xs font-light hidden"
                >
                    Instalar
                </button>
                <button 
                    id="profile-btn"
                    class="px-3 sm:px-4 py-1.5 sm:py-2 border border-white/30 hover:border-white text-white hover:bg-white/10 transition-colors uppercase tracking-wider text-xs font-light"
                >
                    Perfil
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b border-gray-200 flex overflow-x-auto sticky top-[45px] sm:top-[53px] z-10">
            <button class="tab-btn flex-1 px-3 sm:px-4 py-3 sm:py-3.5 border-b-2 border-red-600 text-red-600 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light" data-tab="inicio">Modelos</button>
            <button class="tab-btn flex-1 px-3 sm:px-4 py-3 sm:py-3.5 border-b-2 border-transparent text-gray-600 hover:text-red-600 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light" data-tab="fcm-tokens">Tokens FCM</button>
        </nav>

        <!-- Main Content -->
        <main class="px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
            <!-- Tab: Inicio (Modelos) -->
            <div id="inicio-tab" class="tab-content">
                <div id="entity-content">
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">Cargando modelos...</p>
                    </div>
                </div>
            </div>

            <!-- Tab: FCM Tokens -->
            <div id="fcm-tokens-tab" class="tab-content hidden">
                <div class="mb-4 sm:mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4">
                    <div>
                        <h2 class="text-lg sm:text-xl font-light tracking-tight text-gray-800 mb-1">Gestión de Tokens FCM</h2>
                        <p class="text-sm sm:text-base text-gray-600">Gestiona tokens y envía notificaciones a dispositivos</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="new-fcm-token-btn" class="px-4 py-2 bg-red-600 text-white border border-red-600 hover:bg-red-700 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light">
                            Nuevo Token
                        </button>
                        <button id="send-notification-btn" class="px-4 py-2 bg-green-600 text-white border border-green-600 hover:bg-green-700 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light">
                            Enviar Notificación
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="fcm-tokens-search-input" placeholder="Buscar tokens..." 
                        class="w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-red-600 bg-white text-sm rounded">
                </div>
                
                <div id="fcm-tokens-list" class="space-y-3"></div>
                
                <!-- Formulario de Token -->
                <div id="fcm-token-form" class="border border-gray-200 p-4 mt-4 hidden">
                    <div class="mb-4 border-b border-gray-200 pb-4 flex justify-between items-center">
                        <h3 id="fcm-token-form-title" class="text-lg font-light">Nuevo Token FCM</h3>
                        <button id="close-fcm-token-form" class="text-gray-400 hover:text-red-600 text-xl">×</button>
                    </div>
                    <form id="fcm-token-form-element">
                        <input type="hidden" id="fcm-token-id">
                        <div class="mb-4">
                            <label class="block mb-2 text-xs uppercase tracking-wider text-gray-600">Token FCM *</label>
                            <input type="text" id="fcm-token-token" required 
                                class="w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-red-600 bg-white text-sm">
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-xs uppercase tracking-wider text-gray-600">Nombre del Dispositivo</label>
                            <input type="text" id="fcm-token-device-name" 
                                class="w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-red-600 bg-white text-sm">
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-xs uppercase tracking-wider text-gray-600">Plataforma</label>
                            <select id="fcm-token-platform" 
                                class="w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-red-600 bg-white text-sm">
                                <option value="">Seleccione...</option>
                                <option value="android">Android</option>
                                <option value="ios">iOS</option>
                                <option value="web">Web</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="fcm-token-active" checked class="mr-2">
                                <span class="text-xs uppercase tracking-wider text-gray-600">Activo</span>
                            </label>
                        </div>
                        <div class="flex gap-2 pt-4 border-t border-gray-200">
                            <button type="submit" id="save-fcm-token-btn"
                                class="flex-1 px-4 py-2 bg-green-600 text-white border border-green-600 hover:bg-green-700 transition-colors uppercase tracking-wider text-xs font-light">
                                Guardar
                            </button>
                            <button type="button" id="cancel-fcm-token-btn" 
                                class="flex-1 px-4 py-2 border border-gray-300 hover:border-red-600 hover:text-red-600 transition-colors uppercase tracking-wider text-xs font-light">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Formulario de Notificación -->
                <div id="notification-form" class="border border-gray-200 p-4 mt-6 hidden">
                    <div class="mb-4 border-b border-gray-200 pb-4 flex justify-between items-center">
                        <h3 class="text-lg font-light">Enviar Notificación</h3>
                        <button id="close-notification-form" class="text-gray-400 hover:text-red-600 text-xl">×</button>
                    </div>
                    <form id="notification-form-element">
                        <div class="mb-4">
                            <label class="block mb-2 text-xs uppercase tracking-wider text-gray-600">Título *</label>
                            <input type="text" id="notification-title" required 
                                class="w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-red-600 bg-white text-sm">
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-xs uppercase tracking-wider text-gray-600">Mensaje *</label>
                            <textarea id="notification-message" required rows="4"
                                class="w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-red-600 bg-white text-sm"></textarea>
                        </div>
                        <div class="flex gap-2 pt-4 border-t border-gray-200">
                            <button type="submit" id="send-notification-btn-submit"
                                class="flex-1 px-4 py-2 bg-green-600 text-white border border-green-600 hover:bg-green-700 transition-colors uppercase tracking-wider text-xs font-light">
                                Enviar Notificación
                            </button>
                            <button type="button" id="cancel-notification-btn" 
                                class="flex-1 px-4 py-2 border border-gray-300 hover:border-red-600 hover:text-red-600 transition-colors uppercase tracking-wider text-xs font-light">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
            </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full border border-gray-200 shadow-lg">
            <div class="p-4 sm:p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg sm:text-xl font-light tracking-tight">Perfil de Usuario</h3>
                <button id="close-profile-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="profile-modal-content" class="p-4 sm:p-6">
                <!-- User data will be inserted here -->
            </div>
            <div class="p-4 sm:p-6 border-t border-gray-200 space-y-2">
                <a href="https://yosbany.github.io/nrd-portal" 
                  class="block w-full px-4 py-2 bg-blue-600 text-white border border-blue-600 hover:bg-blue-700 transition-colors uppercase tracking-wider text-xs font-light text-center">
                  Ir al Portal
                </a>
                <button id="profile-logout-btn" class="w-full px-4 py-2 bg-red-600 text-white hover:bg-red-700 transition-colors uppercase tracking-wider text-xs font-light">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </div>

    <!-- Generic Modal for CRUD operations -->
    <div id="crud-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] border border-gray-200 shadow-lg modal-scroll">
            <div id="crud-modal-header" class="p-4 sm:p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white">
                <h3 id="crud-modal-title" class="text-lg sm:text-xl font-light tracking-tight"></h3>
                <button id="close-crud-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                        </button>
                    </div>
            <div id="crud-modal-content" class="p-4 sm:p-6">
                <!-- Form content will be inserted here -->
            </div>
            <div id="crud-modal-footer" class="p-4 sm:p-6 border-t border-gray-200 flex justify-end gap-2 sticky bottom-0 bg-white">
                <!-- Buttons will be inserted here -->
                        </div>
                    </div>
                </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full border border-gray-200 shadow-lg">
            <div class="p-4 sm:p-6 border-b border-gray-200">
                <h3 id="confirm-modal-title" class="text-lg sm:text-xl font-light tracking-tight text-gray-800">Confirmar Acción</h3>
            </div>
            <div class="p-4 sm:p-6">
                <p id="confirm-modal-message" class="text-sm sm:text-base text-gray-600"></p>
            </div>
            <div class="p-4 sm:p-6 border-t border-gray-200 flex justify-end gap-2">
                <button 
                    id="confirm-modal-cancel"
                    class="px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors uppercase tracking-wider text-xs font-light"
                >
                    Cancelar
                </button>
                <button 
                    id="confirm-modal-confirm"
                    class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 transition-colors uppercase tracking-wider text-xs font-light"
                >
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Confirmation Modal -->
    <div id="notification-confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full border border-gray-200 shadow-lg">
            <div class="p-4 sm:p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg sm:text-xl font-light tracking-tight">Confirmar Envío</h3>
                <button id="close-notification-confirm-modal" class="text-gray-400 hover:text-red-600 text-xl font-light">×</button>
            </div>
            <div class="p-4 sm:p-6 space-y-4">
                <p class="text-sm sm:text-base text-gray-700 text-center mb-4">
                    ¿Cómo desea enviar la notificación?
                </p>
                <div class="space-y-3">
                    <button id="notification-send-now-btn" 
                        class="w-full px-4 py-3 bg-blue-600 text-white border border-blue-600 hover:bg-blue-700 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light rounded">
                        <div class="flex items-center justify-center gap-2">
                            <span>⚡</span>
                            <span>Enviar Ahora</span>
                        </div>
                        <div class="text-xs font-light mt-1 opacity-90">
                            Ejecutar workflow inmediatamente
                        </div>
                    </button>
                    <button id="notification-send-scheduled-btn" 
                        class="w-full px-4 py-3 bg-gray-600 text-white border border-gray-600 hover:bg-gray-700 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light rounded">
                        <div class="flex items-center justify-center gap-2">
                            <span>⏰</span>
                            <span>Programado</span>
                        </div>
                        <div class="text-xs font-light mt-1 opacity-90">
                            Se enviará en los próximos 5 minutos
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Result Modal -->
    <div id="notification-result-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full border border-gray-200 shadow-lg">
            <div class="p-4 sm:p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 id="notification-result-title" class="text-lg sm:text-xl font-light tracking-tight">Resultado del Envío</h3>
                <button id="close-notification-result-modal" class="text-gray-400 hover:text-red-600 text-xl font-light">×</button>
            </div>
            <div class="p-4 sm:p-6 space-y-4">
                <div id="notification-result-icon" class="text-center text-4xl mb-2"></div>
                <div id="notification-result-type" class="text-center mb-2">
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-light uppercase tracking-wider"></span>
                </div>
                <p id="notification-result-message" class="text-sm sm:text-base text-gray-700 text-center"></p>
            </div>
            <div class="p-4 sm:p-6 border-t border-gray-200">
                <button id="notification-result-confirm-btn" 
                    class="w-full px-4 sm:px-6 py-2 bg-red-600 text-white border border-red-600 hover:bg-red-700 transition-colors uppercase tracking-wider text-xs sm:text-sm font-light">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Close CRUD Modal Handler -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const closeCrudModalBtn = document.getElementById('close-crud-modal');
        if (closeCrudModalBtn) {
          closeCrudModalBtn.addEventListener('click', () => {
            const modal = document.getElementById('crud-modal');
            if (modal) {
              modal.classList.add('hidden');
            }
          });
            }

        // Close modal on outside click
        const crudModal = document.getElementById('crud-modal');
        if (crudModal) {
          crudModal.addEventListener('click', (e) => {
            if (e.target === crudModal) {
              crudModal.classList.add('hidden');
            }
          });
        }
      });
    </script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    </script>
</body>
</html>
